<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Questões</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <div class="container mt-5">
    <!-- Top Components Section -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4>Gerador de Questões</h4>
      </div>
      <div class="card-body">
        <!-- API Key Input -->
        <div class="mb-3">
          <label for="apiKey" class="form-label">Chave de API do ChatGPT</label>
          <input type="text" class="form-control" id="apiKey" placeholder="Insira sua chave de API">
        </div>

        <!-- Row for Question Type, Complexity Level, and Bloom Dimension -->
        <div class="row mb-3">
          <!-- Select for Question Type -->
          <div class="col-md-4">
            <label for="questionType" class="form-label">Tipo de Questão</label>
            <select class="form-select" id="questionType">
              <option selected disabled>Escolha o tipo de questão</option>
              <option value="unica">Itens de resposta única (múltipla escolha)</option>
              <option value="multipla">Itens de resposta múltipla</option>
              <option value="asserção-razão">Itens do tipo asserção-razão</option>
            </select>
          </div>

          <!-- Radio buttons for Complexity Level -->
          <div class="col-md-4">
            <label class="form-label">Nível de Complexidade</label>
            <div class="d-flex">
              <div class="form-check me-3">
                <input class="form-check-input" type="radio" name="complexity" id="easy" value="fácil">
                <label class="form-check-label" for="easy">Fácil</label>
              </div>
              <div class="form-check me-3">
                <input class="form-check-input" type="radio" name="complexity" id="medium" value="médio">
                <label class="form-check-label" for="medium">Médio</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="complexity" id="hard" value="difícil">
                <label class="form-check-label" for="hard">Difícil</label>
              </div>
            </div>
          </div>

          <!-- Select for Bloom's Taxonomy Dimension -->
          <div class="col-md-4">
            <label for="bloomDimension" class="form-label">Dimensão - Taxonomia de Bloom Revisada</label>
            <select class="form-select" id="bloomDimension">
              <option selected disabled>Escolha a dimensão de avaliação</option>
              <option value="lembrar">Lembrar</option>
              <option value="entender">Entender</option>
              <option value="aplicar">Aplicar</option>
              <option value="analisar">Analisar</option>
              <option value="avaliar">Avaliar</option>
              <option value="criar">Criar</option>
            </select>
          </div>
        </div>

        <!-- Input for Description of the Request -->
        <div class="mb-3">
          <label for="description" class="form-label">Descrição da Solicitação da Questão</label>
          <textarea class="form-control" id="description" rows="3"
            placeholder="Descreva a solicitação do conteúdo da questão"></textarea>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center mb-3" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <p id="timer"></p>
        </div>

        <!-- Generate Question Button -->
        <button class="btn btn-primary" id="generateQuestion">Gerar Questão</button>
      </div>
    </div>

    <!-- Card to Show Generated Question -->
    <div class="card" id="generatedQuestionCard" style="display: none;">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Questão Gerada</h4>
        <button id="downloadJson" class="btn btn-outline-light">
          <i class="fa-solid fa-cloud-arrow-down"></i>
        </button>
      </div>
      <div class="card-body">
        <h5 id="titulo-texto-base" class="card-title"></h5>
        <p id="conteudo-texto-base" class="card-text"></p>
        <h5>Enunciado</h5>
        <p id="texto-enunciado"></p>
        <h5>Afirmativas</h5>
        <ul class="list-group" id="afirmacoes-list"></ul>
        <h5>Opções de Resposta</h5>
        <div class="list-group" id="opcoes-resposta-list"></div>
        <h5>Explicações Detalhadas</h5>
        <div id="explicacoes-detalhadas" class="accordion"></div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      // Load API key from localStorage
      if (localStorage.getItem("apiKey")) {
        $('#apiKey').val(localStorage.getItem("apiKey"));
      }

      // Save API key in localStorage on input change
      $('#apiKey').on('change', function () {
        localStorage.setItem("apiKey", $(this).val());
      });

      // Handle generate question button click
      $('#generateQuestion').on('click', function () {
        const apiKey = $('#apiKey').val();
        const questionType = $('#questionType').val();
        const complexity = $('input[name="complexity"]:checked').val();
        const description = $('#description').val();
        const bloomDimension = $('#bloomDimension').val();

        if (!apiKey || !questionType || !complexity || !description || !bloomDimension) {
          alert("Preencha todos os campos antes de gerar a questão.");
          return;
        }

        // Show loading spinner
        $('#loading').show();

        let startTime = new Date().getTime();
        let timerInterval = setInterval(function () {
          let currentTime = new Date().getTime();
          let elapsed = (currentTime - startTime) / 1000;
          $('#timer').text(`Tempo decorrido: ${elapsed.toFixed(2)} segundos`);
        }, 100);

        // Prepare the system input and user input for API
        let system_input = '';
        let user_input = '';
        const system_input_format = `
O retorno deverá ser em um objeto json, com o schema abaixo:

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Generated schema for Root",
  "type": "object",
  "properties": {
    "textoBase": {
      "type": "object",
      "properties": {
        "titulo": {
          "type": "string"
        },
        "conteudo": {
          "type": "string"
        }
      },
      "required": [
        "titulo",
        "conteudo"
      ]
    },
    "enunciado": {
      "type": "object",
      "properties": {
        "texto": {
          "type": "string"
        }
      },
      "required": [
        "texto"
      ]
    },
    "afirmacoes": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "texto": {
            "type": "string"
          },
          "correta": {
            "type": "boolean"
          },
          "explicacao": {
            "type": "string"
          }
        },
        "required": [
          "id",
          "texto",
          "correta"
        ]
      }
    },
    "opcoesDeResposta": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "letra": {
            "type": "string"
          },
          "texto": {
            "type": "string"
          },
          "correta": {
            "type": "boolean"
          },
          "justificativa": {
            "type": "string"
          }
        },
        "required": [
          "letra",
          "texto",
          "correta",
          "justificativa"
        ]
      }
    },
    "explicacoesDetalhadas": {
      "type": "object",
      "properties": {
        "afirmacaoI": {
          "type": "object",
          "properties": {
            "correta": {
              "type": "boolean"
            },
            "explicacao": {
              "type": "string"
            }
          },
          "required": [
            "correta",
            "explicacao"
          ]
        },
        "afirmacaoII": {
          "type": "object",
          "properties": {
            "correta": {
              "type": "boolean"
            },
            "explicacao": {
              "type": "string"
            }
          },
          "required": [
            "correta",
            "explicacao"
          ]
        },
        "afirmacaoIII": {
          "type": "object",
          "properties": {
            "correta": {
              "type": "boolean"
            },
            "explicacao": {
              "type": "string"
            }
          },
          "required": [
            "correta",
            "explicacao"
          ]
        },
        "afirmacaoIV": {
          "type": "object",
          "properties": {
            "correta": {
              "type": "boolean"
            },
            "explicacao": {
              "type": "string"
            }
          },
          "required": [
            "correta",
            "explicacao"
          ]
        }
      },
      "required": [
        "afirmacaoI",
        "afirmacaoII",
        "afirmacaoIII",
        "afirmacaoIV"
      ]
    }
  },
  "required": [
    "textoBase",
    "enunciado",
    "afirmacoes",
    "opcoesDeResposta",
    "explicacoesDetalhadas"
  ]
}`;

        // Prepare specific prompts for each question type
        switch (questionType) {
          case 'unica':
            system_input = `
Você é um professor de educação superior e deverá construir uma questão de múltipla escolha do tipo 'Itens de Resposta Única' seguindo os critérios abaixo:

- A questão deve seguir as diretrizes para 'Itens de Resposta Única' apresentadas no documento fornecido.
- A questão deve avaliar a competência na dimensão de avaliação '${bloomDimension}' da Taxonomia de Bloom Revisada.
- A questão deve ser inédita e original, não copiada de nenhuma fonte.
- O texto-base deve ser claro, conciso e fornecer todas as informações necessárias.
- As opções de resposta devem incluir um gabarito correto e distratores plausíveis.
- As opções de resposta devem seguir as recomendações de construção de itens de múltipla escolha, evitando termos como 'sempre', 'nunca', 'todos', 'nenhum', etc.
`;
            user_input = `Crie uma questão de nível ${complexity}, no formato 'Itens de Resposta Única', sobre o tema '${description}', com foco na dimensão de avaliação '${bloomDimension}'.`;
            break;
          case 'multipla':
            system_input = `
Você é um professor de educação superior e deverá construir uma questão de múltipla escolha do tipo 'Itens de Resposta Múltipla' seguindo os critérios abaixo:

- A questão deve seguir as diretrizes para 'Itens de Resposta Múltipla' apresentadas no documento fornecido.
- A questão deve avaliar a competência na dimensão de avaliação '${bloomDimension}' da Taxonomia de Bloom Revisada.
- A questão deve ser inédita e original, não copiada de nenhuma fonte.
- O texto-base deve ser claro, conciso e fornecer todas as informações necessárias.
- As afirmações devem ser independentes, claras e objetivas.
- A chave de resposta deve estar balanceada, conforme as recomendações do documento.
- Evitar termos negativos ou que possam induzir o estudante ao erro.
`;
            user_input = `Crie uma questão de nível ${complexity}, no formato 'Itens de Resposta Múltipla', sobre o tema '${description}', com foco na dimensão de avaliação '${bloomDimension}'.`;
            break;
          case 'asserção-razão':
            system_input = `
Você é um professor de educação superior e deverá construir uma questão de múltipla escolha do tipo 'Itens do Tipo Asserção-Razão' seguindo os critérios abaixo:

- A questão deve seguir as diretrizes para 'Itens do Tipo Asserção-Razão' apresentadas no documento fornecido.
- A questão deve avaliar a competência na dimensão de avaliação '${bloomDimension}' da Taxonomia de Bloom Revisada.
- A questão deve ser inédita e original, não copiada de nenhuma fonte.
- O texto-base deve ser claro, conciso e fornecer todas as informações necessárias.
- As duas proposições (asserções) devem ser relacionadas ao tema e permitir avaliar se são verdadeiras ou falsas e se a segunda é uma justificativa correta da primeira.
- As opções de resposta devem seguir o padrão estabelecido, conforme o exemplo do documento.
- Evitar termos negativos ou que possam induzir o estudante ao erro.
`;
            user_input = `Crie uma questão de nível ${complexity}, no formato 'Itens do Tipo Asserção-Razão', sobre o tema '${description}', com foco na dimensão de avaliação '${bloomDimension}'.`;
            break;
          default:
            alert("Tipo de questão inválido.");
            clearInterval(timerInterval); // Stop timer
            $('#loading').hide();
            return;
        }

        // AJAX request to the API
        var settings = {
          "url": "https://api.openai.com/v1/chat/completions",
          "method": "POST",
          "timeout": 0,
          "headers": {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          "data": JSON.stringify({
            "model": "gpt-4-turbo-2024-04-09",
            "messages": [
              {
                "role": "system",
                "content": system_input
              },
              {
                "role": "system",
                "content": system_input_format
              },
              {
                "role": "user",
                "content": user_input
              }
            ],
            "temperature": 0.7,
            "max_tokens": 2048,
            "top_p": 1
          }),
        };

        $.ajax(settings).done(function (response) {
          clearInterval(timerInterval); // Stop timer

          // Limpeza da resposta para remover o delimitador de bloco de código ```json
          let contentRaw = response.choices[0].message.content;

          // Remove o ```json do início e ``` do final
          let cleanedContent = contentRaw.replace(/```json|```/g, '').trim();

          try {
            const content = JSON.parse(cleanedContent);

            console.log(content);

            // Populate question in the UI
            $('#titulo-texto-base').text(content.textoBase.titulo);
            $('#conteudo-texto-base').text(content.textoBase.conteudo);
            $('#texto-enunciado').text(content.enunciado.texto);

            // Limpa a lista de afirmativas e verifica se existe o campo "afirmacoes"
            $('#afirmacoes-list').empty();
            if (content.afirmacoes && content.afirmacoes.length > 0) {
              content.afirmacoes.forEach(afirmacao => {
                $('#afirmacoes-list').append(`<li class="list-group-item">${afirmacao.id}. ${afirmacao.texto}</li>`);
              });
            }

            // Limpa as opções de resposta e popula com as novas informações
            $('#opcoes-resposta-list').empty();
            if (content.opcoesDeResposta && content.opcoesDeResposta.length > 0) {
              content.opcoesDeResposta.forEach(opcao => {
                const listClass = opcao.correta ? 'list-group-item-success' : 'list-group-item-danger';
                $('#opcoes-resposta-list').append(`<div class="list-group-item ${listClass}">${opcao.letra}. ${opcao.texto} - ${opcao.justificativa}</div>`);
              });
            }

            // Limpa as explicações detalhadas e popula com as novas informações
            $('#explicacoes-detalhadas').empty();
            let index = 1;
            const options = ['I', 'II', 'III', 'IV'];
            for (let key in content.explicacoesDetalhadas) {
              const explicacao = content.explicacoesDetalhadas[key];
              $('#explicacoes-detalhadas').append(`
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${index}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                            Afirmativa ${options[index - 1]}
                        </button>
                    </h2>
                    <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}">
                        <div class="accordion-body">${explicacao.explicacao}</div>
                    </div>
                </div>
            `);
              index++;
            }

            // Hide loading spinner
            $("#generatedQuestionCard").show();
            $('#loading').hide();

            // Prepare data for download as JSON
            const jsonData = {
              questionType: questionType,
              complexity: complexity,
              description: description,
              bloomDimension: bloomDimension,
              question: content,
              gpt: {
                  id: response.id,
                  object: response.object,
                  created: response.created,
                  model: response.model,
                  choices: response.choices,
                  usage: response.usage,
                  system_fingerprint: response.system_fingerprint
              }
            };

            // Handle download button click
            $('#downloadJson').on('click', function () {
              const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonData, null, 2));
              const downloadAnchorNode = document.createElement('a');
              downloadAnchorNode.setAttribute("href", dataStr);
              downloadAnchorNode.setAttribute("download", "questao_gerada.json");
              document.body.appendChild(downloadAnchorNode); // required for firefox
              downloadAnchorNode.click();
              downloadAnchorNode.remove();
            });

          } catch (error) {
            console.error("Erro ao processar o JSON: ", error);
            alert("Erro ao processar a resposta da API. O conteúdo não pôde ser interpretado corretamente.");
            $('#loading').hide();
          }
        }).fail(function (jqXHR, textStatus, errorThrown) {
          clearInterval(timerInterval); // Stop timer

          // Show error message
          alert(`Erro: ${textStatus} - ${errorThrown}`);

          // Hide loading spinner
          $('#loading').hide();
        });

      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>